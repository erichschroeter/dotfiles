#!/usr/bin/env bash
# Save and restore the state of tmux sessions, windows and panes.
set -e

dump() {
  local d=$'\t'
  tmux list-windows -a -F "#S${d}#W${d}#{window_layout}" |
    while IFS=$'\t' read -r session window layout; do
      printf "%s%s%s%s%s" "$session" "$d" "$window" "$d" "$layout"
      tmux list-panes -t "$session:$window" -F "${d}#{pane_current_path}" | tr -d '\n'
      echo
    done
}

save() {
  local session_file
  if [ -z "$1" ]; then
    session_file="$HOME/.tmux-session"
  else
    session_file="$1"
  fi
  dump > "$session_file"
}

terminal_size() {
  stty size 2>/dev/null | awk '{ printf "-x%d -y%d", $2, $1 }'
}

session_exists() {
  tmux has-session -t "$1" 2>/dev/null
}

add_window() {
  tmux new-window -d -t "$1:" -n "$2" -c "$3"
}

new_session() {
  cd "$3" &&
  tmux new-session -d -s "$1" -n "$2" $4
}

restore() {
  local session_file
  if [ -z "$1" ]; then
    session_file="$HOME/.tmux-session"
  else
    session_file="$1"
  fi
  tmux start-server
  local count=0
  local dimensions="$(terminal_size)"

  while read -r line; do
    IFS=$'\t' read -r -a fields <<< "$line"
    if [ ${#fields[@]} -lt 4 ]; then
      continue
    fi

    local session_name="${fields[0]}"
    local window_name="${fields[1]}"
    local layout="${fields[2]}"
    local first_dir="${fields[3]}"

    if [[ -d "$first_dir" && $window_name != "log" && $window_name != "man" ]]; then
      if session_exists "$session_name"; then
        add_window "$session_name" "$window_name" "$first_dir"
      else
        new_session "$session_name" "$window_name" "$first_dir" "$dimensions"
        count=$(( count + 1 ))
      fi

      if [ ${#fields[@]} -gt 4 ]; then
        for i in $(seq 4 $((${#fields[@]} - 1))); do
          local pane_dir="${fields[$i]}"
          if [[ -d "$pane_dir" ]]; then
            tmux split-window -d -t "$session_name:$window_name" -c "$pane_dir"
          fi
        done
      fi

      tmux select-layout -t "$session_name:$window_name" "$layout"
    fi
  done < "$session_file"

  echo "restored $count sessions"
}

case "$1" in
save | restore )
  $1 "$2"
  ;;
* )
  echo "valid commands: save, restore" >&2
  exit 1
esac